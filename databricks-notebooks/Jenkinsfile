pipeline {
    agent any

    environment {
        DATABRICKS_HOST = 'https://community.cloud.databricks.com'
        DATABRICKS_TOKEN = credentials('databricks-token')
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                echo 'Repository checked out'
            }
        }

        stage('Install Dependencies') {
            steps {
                sh '''
                    apt-get update && apt-get install -y python3 python3-pip
                    pip3 install databricks-cli
                    databricks --version
                '''
            }
        }

        stage('Configure Databricks') {
            steps {
                sh '''
                    cat > ~/.databrickscfg <<EOF
[DEFAULT]
host = ${DATABRICKS_HOST}
token = ${DATABRICKS_TOKEN}
EOF
                '''
            }
        }

        stage('Deploy Bronze Notebook') {
            steps {
                sh '''
                    databricks workspace import databricks-notebooks/bronze/01_bronze_layer_ingestion.py /Users/vuppalaadarsh28@gmail.com/01_bronze_layer_ingestion --language PYTHON --format SOURCE --overwrite
                '''
            }
        }

        stage('Deploy Silver Notebook') {
            steps {
                sh '''
                    databricks workspace import databricks-notebooks/silver/02_silver_layer_transformation.py /Users/vuppalaadarsh28@gmail.com/02_silver_layer_transformation --language PYTHON --format SOURCE --overwrite
                '''
            }
        }

        stage('Deploy Gold Notebook') {
            steps {
                sh '''
                    databricks workspace import databricks-notebooks/gold/03_gold_layer_analytics.py /Users/vuppalaadarsh28@gmail.com/03_gold_layer_analytics --language PYTHON --format SOURCE --overwrite
                '''
            }
        }

        stage('Validation') {
            steps {
                echo 'Bronze layer deployment: SUCCESS'
                echo 'Silver layer deployment: SUCCESS'
                echo 'Gold layer deployment: SUCCESS'
            }
        }
    }

    post {
        success {
            echo 'Pipeline completed successfully'
        }
        failure {
            echo 'Pipeline failed'
        }
    }
}
