pipeline {
    agent any

    environment {
        DATABRICKS_HOST = 'https://community.cloud.databricks.com'
        DATABRICKS_TOKEN = credentials('databricks-token')
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                echo 'Repository checked out'
            }
        }

        stage('Install Dependencies') {
            agent {
                docker {
                    image 'python:3.9-slim'
                    reuseNode true
                }
            }
            steps {
                sh '''
                    pip3 install databricks-cli
                    databricks --version
                '''
            }
        }

        stage('Deploy Notebooks') {
            agent {
                docker {
                    image 'python:3.9-slim'
                    reuseNode true
                }
            }
            steps {
                sh '''
                    pip3 install databricks-cli

                    cat > ~/.databrickscfg <<EOF
[DEFAULT]
host = ${DATABRICKS_HOST}
token = ${DATABRICKS_TOKEN}
EOF

                    databricks workspace import databricks-notebooks/bronze/01_bronze_layer_ingestion.py /Users/vuppalaadarsh28@gmail.com/01_bronze_layer_ingestion --language PYTHON --format SOURCE --overwrite
                    echo 'Bronze layer deployed'

                    databricks workspace import databricks-notebooks/silver/02_silver_layer_transformation.py /Users/vuppalaadarsh28@gmail.com/02_silver_layer_transformation --language PYTHON --format SOURCE --overwrite
                    echo 'Silver layer deployed'

                    databricks workspace import databricks-notebooks/gold/03_gold_layer_analytics.py /Users/vuppalaadarsh28@gmail.com/03_gold_layer_analytics --language PYTHON --format SOURCE --overwrite
                    echo 'Gold layer deployed'
                '''
            }
        }

        stage('Validation') {
            steps {
                echo 'Bronze layer deployment: SUCCESS'
                echo 'Silver layer deployment: SUCCESS'
                echo 'Gold layer deployment: SUCCESS'
            }
        }
    }

    post {
        success {
            echo 'Pipeline completed successfully'
        }
        failure {
            echo 'Pipeline failed'
        }
    }
}
